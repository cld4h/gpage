---
title: 联想倍爱宝
date: 2019-10-25 12:44:32
tags:
---

本文是我对联想倍爱宝固件的初步分析过程的梳理，本人初步接触对固件Forensics和逆向的工作，有疏漏和错误欢迎多多指正！

相关资料内容比较大的我就不以链接形式放在文中了，可以在我的nextcloud上下载:
https://cloud.dns.army:404/s/5z295fiKkaakMca

## 目标

获得敏感数据，如密码等存储等
查明通信协议，远端APP连接等


## 确认硬件设备

### 通过 binwalk extract 固件

首先需要配置 [binwalk](https://github.com/ReFirmLabs/binwalk) 的环境。Kali上自带binwalk，但缺少一些插件，这些插件能帮助我们解压一些文件系统，为了以防万一，我将所有能装的插件都装上了，包括 [sasquatch](https://github.com/devttys0/sasquatch)，[jefferson](https://github.com/sviehb/jefferson)，[ubi_reader](https://github.com/jrspruitt/ubi_reader) ， [unstuff](http://my.smithmicro.com/downloads/files/stuffit520.611linux-i386.tar.gz)

安装好 binwalk 后，运行 `binwalk -Me GD25Q256C@WSON8 8X6_20190911_155128.BIN` 对固件进行 extraction

在解压出的 `squashfs-root-0/fox/res` 目录下，通过[提示音](wait-setup.wav)发现设备为“联想智能摄像机”，并且有大量[提示音](voice_baby_AI_online.wav) 包含“baby ai”，并且有图标 ![baby ai](logo24.bmp)

搜索固件文件名 `GD25Q256C` 发现这是一个32MB SPI 接口 Flash存储器。[(datasheet)](https://www.novitronic.ch/fm/2/GD25Q256C.pdf)

去联想商城上找到了联想的产品“倍爱宝”:
https://item.lecoo.com/pd/1000609.html

其中有硬件配置说明：
![硬件配置](hardware.png)

[什么值得买](https://post.smzdm.com/p/720320/) 上有对该产品的测评，该产品有安卓客户端，客户端有加固。

我下载并安装了这个apk，并拦截到了apk更新的URL，得到了一个更新的apk文件，该文件仍然有加固。apk也附在了我的nextcloud上

后续可对APK进行分析。

## 继续分析固件

### 概览固件

#### 查看可见字符

通过 `strings -n 20 GD*.BIN > strings.out` 命令
输出不小于20个可见字符的字符串
找到其中可能有价值的内容如下：

```
bootargs=console=ttyS1,115200n8 mem=96M@0x0 ispmem=8M@0x6000000 rmem=24M@0x6800000 init=/linuxrc rootfstype=squashfs root=/dev/mtdblock2 rw mtdparts=jz_sfc:256k(boot),2560k(kernel),2048k(root),-(appfs)
bootcmd=sdupdate; flashcrccheck;
ethaddr=00:11:22:33:44:55
serverip=193.169.4.2
gatewayip=193.169.4.1
netmask=255.255.255.0
```

`console=ttyS1,115200n8` 表示使用ttyS1（第二个串口），
设定波特率115200，no stop bits and 8 data bits.

启动的根文件系统是 `squashfs` ，根设备在mtdparts的第二个分区(mtdblock2)

#### 绘制熵图（以判断是否加密）

##### 使用binwalk绘制熵图

通过 `-E` 选项绘制熵图

![overall entropy](entropy.GD25Q256C.png)

```
DECIMAL       HEXADECIMAL     ENTROPY
--------------------------------------------------------------------------------
0             0x0             Falling entropy edge (0.565658)
327680        0x50000         Rising entropy edge (0.998486)
2129920       0x208000        Falling entropy edge (0.387764)
2293760       0x230000        Rising entropy edge (0.998226)
5128192       0x4E4000        Falling entropy edge (0.000000)
5767168       0x580000        Rising entropy edge (0.998499)
13107200      0xC80000        Falling entropy edge (0.356762)
16252928      0xF80000        Rising entropy edge (0.998097)
16433152      0xFAC000        Falling entropy edge (0.613602)
28835840      0x1B80000       Rising entropy edge (0.998834)
32423936      0x1EEC000       Falling entropy edge (0.237346)
33128448      0x1F98000       Rising entropy edge (0.977469)
33144832      0x1F9C000       Falling entropy edge (0.799506)
33308672      0x1FC4000       Rising entropy edge (0.970751)
33325056      0x1FC8000       Falling entropy edge (0.631231)
33390592      0x1FD8000       Rising entropy edge (0.963340)
33406976      0x1FDC000       Falling entropy edge (0.847329)
```

局部细节：


前五张图是五个极度接近1的 "平台" ，第六个图是头部，第七个图是尾部

![entropy details](entropy-1.png)
![entropy details](entropy-2.png)
![entropy details](entropy-3.png)
![entropy details](entropy-4.png)
![entropy details](entropy-5.png)

头部
![entropy details](entropy-6.png)

尾部
![entropy details](entropy-7.png)

##### 使用binvis.io绘制熵图

![colored entropy](binvis.io-GD25Q256C@WSON8 8X6_20190911_155128.png)

### 分析binwalk解压出来的文件系统

解压报告(后面有一堆zlib压缩的文件，也就是前面熵图尾部内容，是一些文本信息，内容都是键值对的形式，比较像配置文件或是日志等记录状态信息的，不是重点)：

```
root@kali:~# binwalk -Me GD25Q256C@WSON8\ 8X6_20190911_155128.BIN

Scan Time:     2019-10-16 22:38:21
Target File:   /root/GD25Q256C@WSON8 8X6_20190911_155128.BIN
MD5 Checksum:  09ee633c877eceb930952cc10798cdf3
Signatures:    386

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
178876        0x2BABC         CRC32 polynomial table, little endian
183036        0x2CAFC         LZO compressed data
185240        0x2D398         Android bootimg, kernel size: 0 bytes, kernel addr: 0x70657250, ramdisk size: 543519329 bytes, ramdisk addr: 0x6E72656B, product name: "mem boot start"
327680        0x50000         uImage header, header size: 64 bytes, header CRC: 0x12E77154, created: 2017-10-19 03:38:29, image size: 1805541 bytes, Data Address: 0x80010000, Entry Point: 0x803E30F0, data CRC: 0xEABEFE2F, OS: Linux, CPU: MIPS, image type: OS Kernel Image, compression type: lzma, image name: "Linux-3.10.14"
327744        0x50040         LZMA compressed data, properties: 0x5D, dictionary size: 67108864 bytes, uncompressed size: -1 bytes
2293760       0x230000        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 2831924 bytes, 408 inodes, blocksize: 131072 bytes, created: 2018-04-13 13:05:38
5767168       0x580000        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 7343002 bytes, 144 inodes, blocksize: 131072 bytes, created: 2018-06-22 09:31:29
16252928      0xF80000        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 188193 bytes, 5 inodes, blocksize: 131072 bytes, created: 2018-04-13 13:05:38
28835840      0x1B80000       uImage header, header size: 64 bytes, header CRC: 0x55DB12C7, created: 2018-03-21 10:24:42, image size: 3589287 bytes, Data Address: 0x80010000, Entry Point: 0x8031B9C0, data CRC: 0x81B1667E, OS: Linux, CPU: MIPS, image type: OS Kernel Image, compression type: lzma, image name: "Linux-3.10.14"
28835904      0x1B80040       LZMA compressed data, properties: 0x5D, dictionary size: 67108864 bytes, uncompressed size: -1 bytes
33030292      0x1F80094       JFFS2 filesystem, little endian
33030552      0x1F80198       JFFS2 filesystem, little endian
```

#### 分区
结合前面熵图分析文件系统分区：

| 大概位置  | 解压后的文件路径 | 功能                                                      |
| ---       | ---              | ---                                                       |
| 0.3-2MB   | (lzma解压失败)   | unknown                                                   |
| 2MB-5MB   | `squashfs-root`  | /                                                         |
| 5MB-13MB  | `squashfs-root0` | /system                                                   |
| 16MB      | `squashfs-root1` | /appdata，目前内置了第三方"灵云语音唤醒" 的配置文件，很小 |
| 28MB-32MB | (lzma解压失败)   | unknown                                                   |

在`squashfs-root/etc/init.d/rcS` 中，存在下面的修改自动挂载脚本执行权限命令和挂载命令（虽然我不明白这两句话为啥是反着的...）但我们可以认为 mtdblock3 中一定会有 `/etc/lenovo/automount.sh` 文件

```sh
# Auto mount TF bash script add x
if [ -e /system/etc/lenovo/automount.sh ] && [ ! -x /system/etc/lenovo/automount.sh ];then
	chmod +x /system/etc/lenovo/automount.sh
fi

# Mount system partition
mount -t squashfs /dev/mtdblock3 /system
```

搜索 `squashfs-root`、`squashfs-root0`、`squashfs-root1`，只有`squashfs-root0` 有 `automount.sh` (不过在 `etc-default` 中因为后面复制了一波)，我们认为`squashfs-root0` 对应于 `mtdblock3`

因此，下一个mount 的 squashfs 文件系统`squashfs-root1`挂载在`/appdata` 中，大概存放的是应用数据

```sh
# Mount appdata partition
mount -t squashfs /dev/mtdblock4 /appdata

```

另外一些挂载，启动 `poweroffd`
```sh
# Mount configs partition
mount -t jffs2 /dev/mtdblock6 /system/etc

#Start poweroff deamon
poweroffd &
```

复制到`/etc`

```sh
ETC_EMPTY=`ls -A /system/etc | wc -w`
if [ -d /system/etc ] && [ $ETC_EMPTY -eq 0 ];then
	cp -rf /system/etc_default/* /system/etc/
fi
```

运行启动脚本

```sh
# Run user app init script
. /system/etc/lenovo/init.sh

# Run user app script
if [ -f /system/etc/app.sh ]; then
	/system/etc/app.sh &
	touch /var/tmp/completion
fi
```

#### 一些脚本和二进制程序

| 序号 | 路径                       | 功能                                   |
|------|----------------------------|----------------------------------------|
| 1    | /etc/init.d/rcS            | 挂载分区，启动poweroffd，启动2,3       |
| 2    | /system/etc/app.sh         | user app script                        |
| 3    | /system/etc/lenovo/init.sh | 挂载内核模块                           |
| 4    | /mnt/sd/Default.sh         | unknown                                |
| 5    | /system/fox                | 关键程序，位于`squashfs-root0/fox/fox` |

`fox` 值得进一步挖掘。在 user app script （也就是位于jffs2文件系统中的app.sh脚本）中包含如下内容
```sh
	cp -rf /system/fox /dev/
	cd /dev/fox
	chmod +x fox
	./fox &
````

### 试图使用firmadyne通过QEMU进行系统级模拟运行

初步了解[firmadyne](https://github.com/firmadyne/firmadyne):
https://cld4h.github.io/reverse-note/#firmadyne
主要参考其[论文](https://www.dcddcc.com/docs/2016_paper_firmadyne.pdf)

配置环境的过程很难受，firmadyne的作者对QEMU网卡配置的语法在QEMU版本>2.12后不再受支持，
所以只能使用低版本的QEMU

我使用了debian上编译好的一套qemu，但要处理很多乱七八糟的依赖关系，目前还没有找到更好的方法。
https://packages.debian.org/stretch/qemu-system

试图运行，但第一步解压失败，仍待继续探索...

```
root@kali:~/firmadyne# python3 ./sources/extractor/extractor.py -b lenovo -sql 127.0.0.1 -np -nk "/root/GD25Q256C@WSON8 8X6_20190911_155128.BIN" images
>> Database Image ID: 1

/root/GD25Q256C@WSON8 8X6_20190911_155128.BIN
>> MD5: 09ee633c877eceb930952cc10798cdf3
>> Tag: 1
>> Temp: /tmp/tmp8oc9sk3y
>> Status: Kernel: True, Rootfs: False, Do_Kernel: False,                 Do_Rootfs: True
>>>> Zip archive data, at least v2.0 to extract, name: segment_fault.dmp
>> Recursing into archive ...

/tmp/tmp8oc9sk3y/_GD25Q256C@WSON8 8X6_20190911_155128.BIN.extracted/segment_fault.dmp
	>> MD5: d41d8cd98f00b204e9800998ecf8427e
	>> Tag: 1
	>> Temp: /tmp/tmpx8wyjhxn
	>> Status: Kernel: True, Rootfs: False, Do_Kernel: False,                 Do_Rootfs: True
	>> Recursing into archive ...
	>>>> Extraction failed!
	>> Recursing into compressed ...
	>> Cleaning up /tmp/tmpx8wyjhxn...
>>>> Squashfs filesystem, little endian, version 4.0, compression:xz, size: 2831924 bytes, 408 inodes, blocksize: 131072 bytes, created: 2018-04-13 13:05:38
>>>> Extraction failed!
>>>> LZO compressed data
>> Recursing into compressed ...

/tmp/tmp8oc9sk3y/_GD25Q256C@WSON8 8X6_20190911_155128.BIN-1.extracted/50040
	>> MD5: d2eba901dd09718a7674ab0e303303ed
	>> Tag: 1
	>> Temp: /tmp/tmplqqw6bdl
	>> Status: Kernel: True, Rootfs: False, Do_Kernel: False,                 Do_Rootfs: True
	>> Recursing into archive ...
	>>>> Extraction failed!
	>>>> xz compressed data
	>> Recursing into compressed ...
	>> Cleaning up /tmp/tmplqqw6bdl...

/tmp/tmp8oc9sk3y/_GD25Q256C@WSON8 8X6_20190911_155128.BIN-1.extracted/230060
	>> MD5: 9d186d6fdba73dfdb1d584ff46b3c637
	>> Skipping: application/x-executable...

/tmp/tmp8oc9sk3y/_GD25Q256C@WSON8 8X6_20190911_155128.BIN-1.extracted/23D5C8
	>> MD5: a8f48f6261ed7606859014de39d1a617
	>> Tag: 1
	>> Temp: /tmp/tmp_rh50lnc
	>> Status: Kernel: True, Rootfs: False, Do_Kernel: False,                 Do_Rootfs: True
	>>>> POSIX tar archive (GNU)
	>> Recursing into archive ...
	>>>> Extraction failed!
	>> Recursing into compressed ...
	>> Cleaning up /tmp/tmp_rh50lnc...

/tmp/tmp8oc9sk3y/_GD25Q256C@WSON8 8X6_20190911_155128.BIN-1.extracted/24BC18
	>> MD5: 1bf3c1a61c80379bf2fc46756a827784
	>> Tag: 1
	>> Temp: /tmp/tmplegd17s7
	>> Status: Kernel: True, Rootfs: False, Do_Kernel: False,                 Do_Rootfs: True
	>>>> POSIX tar archive (GNU)
	>> Recursing into archive ...
	>>>> Extraction failed!
	>> Recursing into compressed ...
	>> Cleaning up /tmp/tmplegd17s7...

/tmp/tmp8oc9sk3y/_GD25Q256C@WSON8 8X6_20190911_155128.BIN-1.extracted/25A304
	>> MD5: f400699e8e6b5441ff2530c93d63b9b8
	>> Tag: 1
	>> Temp: /tmp/tmp5pc6voj7
	>> Status: Kernel: True, Rootfs: False, Do_Kernel: False,                 Do_Rootfs: True
	>>>> POSIX tar archive (GNU)
	>> Recursing into archive ...
	>>>> Extraction failed!
	>> Recursing into compressed ...
	>> Cleaning up /tmp/tmp5pc6voj7...

/tmp/tmp8oc9sk3y/_GD25Q256C@WSON8 8X6_20190911_155128.BIN-1.extracted/2637E4
	>> MD5: 502a94a00a16cf7ee547dc7882312590
	>> Skipping: application/x-object...
>> Skipping: recursion breadth 5
>> Skipping: completed!
>> Cleaning up /tmp/tmp8oc9sk3y...

```
